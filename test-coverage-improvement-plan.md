# План улучшения покрытия тестами для проекта Translator

## 1. Текущее состояние тестирования

**Существующие тесты:**
- `config_tests.rs` - тесты конфигурации (загрузка, сохранение, сериализация)
- `language_detection_tests.rs` - тесты определения языка
- `language_selection_tests.rs` - тесты алгоритма выбора целевого языка
- `settings_tests.rs` - тесты настроек (сохранение/загрузка последнего языка)

**Модули без тестов:**
- `main.rs` - точка входа (обычно не требует тестирования)
- `ui.rs` - UI компоненты (сложно тестировать, но возможно)
- `translation.rs` - функция перевода (требует моков для API)

## 2. Инструменты для измерения покрытия

Рекомендую использовать **cargo-llvm-cov**, так как он:
- Более точный, чем tarpaulin
- Использует встроенную в Rust поддержку LLVM coverage
- Работает на всех платформах
- Активно поддерживается

## 3. План действий

### Шаг 1: Установка инструментов
```bash
# Установка cargo-llvm-cov
cargo install cargo-llvm-cov

# Установка llvm-tools (если еще не установлены)
rustup component add llvm-tools-preview
```

### Шаг 2: Измерение текущего покрытия
```bash
# Генерация отчета о покрытии
cargo llvm-cov --html

# Открытие отчета в браузере
cargo llvm-cov --open
```

### Шаг 3: Добавление недостающих тестов

**3.1. Тесты для translation.rs:**
- Мокировать OpenAI API вызовы
- Тестировать обработку ошибок API
- Тестировать пустой текст
- Тестировать корректное формирование запросов

**3.2. Тесты для ui.rs (частично):**
- Тестировать функцию `choose_target_language` (уже есть)
- Тестировать логику обновления кнопок
- Тестировать обработку ошибок чтения буфера обмена

**3.3. Улучшение существующих тестов:**
- Добавить тесты граничных случаев
- Тестирование ошибок файловой системы
- Тестирование некорректных конфигураций

### Шаг 4: Интеграционные тесты
- Тестирование полного flow приложения
- Тестирование взаимодействия между модулями
- Тестирование с реальными файлами конфигурации

### Шаг 5: CI/CD интеграция
```yaml
# Добавить в GitHub Actions workflow
- name: Run tests with coverage
  run: |
    cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
    
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v1
  with:
    files: lcov.info
```

## 4. Конкретные рекомендации по модулям

### translation.rs
```rust
#[cfg(test)]
mod tests {
    use super::*;
    use mockall::predicate::*;
    use mockall::mock;
    
    // Мок для OpenAI клиента
    mock! {
        OpenAIClient {
            async fn translate(&self, text: &str, target: Language) -> Result<String, Error>;
        }
    }
    
    #[tokio::test]
    async fn test_empty_text_translation() {
        // Тест для пустого текста
    }
    
    #[tokio::test]
    async fn test_api_error_handling() {
        // Тест обработки ошибок API
    }
}
```

### ui.rs
```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_update_active_button_simple() {
        // Тест обновления состояния кнопок
    }
    
    #[test]
    fn test_clipboard_error_handling() {
        // Тест обработки ошибок буфера обмена
    }
}
```

## 5. Цели покрытия

- **Минимальное покрытие**: 70%
- **Рекомендуемое покрытие**: 80-85%
- **Для критических модулей** (config, settings): 90%+

## 6. Дополнительные улучшения

- Использовать property-based testing для сложных алгоритмов
- Добавить бенчмарки для критичных по производительности участков
- Настроить pre-commit хуки для запуска тестов
- Добавить badge покрытия в README.md

## 7. Приоритеты

1. **Высокий приоритет:**
   - Тесты для `translation.rs` (основная функциональность)
   - Интеграционные тесты
   - CI/CD интеграция

2. **Средний приоритет:**
   - Улучшение существующих тестов
   - Тесты для частично тестируемых UI компонентов
   - Property-based тесты

3. **Низкий приоритет:**
   - Полное покрытие UI компонентов
   - Бенчмарки
   - Косметические улучшения

Этот план поможет систематически улучшить покрытие тестами и качество кода проекта.